###  PEEK INSIDE GPT-2 using directional derivative & concept activation vector  ###
# Task repository
""" WITHOUT CONTEXT:
context_texts = [
    "The story is set in the remote village of Eldergrove, surrounded by an ancient forest that is said to be enchanted. The village, largely cut off from the outside world, thrives on myths and legends passed down through generations. The villagers live simple lives, tending to their crops and livestock, while sharing tales of magical creatures and hidden realms. Finn, the old man at the heart of these stories, arrived in Eldergrove decades ago under mysterious circumstances and quickly became an integral yet enigmatic part of the community. He is known for his unusual behavior, such as collecting peculiar artifacts and speaking in riddles, which fuels the village's curiosity and speculation. Elara, a bright and adventurous twelve-year-old girl, has always been fascinated by the stories and dreams of discovering the forest's secrets. With her unwavering spirit and sense of wonder, she decides to follow Finn one fateful night, setting off a chain of events that will forever change the village's understanding of their world and their place within it.",
    "The story takes place in the year 2050, a time when Earth's oceans have become a focus of exploration and preservation due to climate change and technological advancements. Kai is a marine biologist and an avid diver, part of a research team studying the effects of environmental changes on marine life. His love for the ocean is deeply rooted in his childhood, filled with stories of mythical underwater realms and creatures. The hidden city of Aralume, unknown to humans, has thrived for millennia, relying on its powerful enchantments to shield it from discovery. The merfolk of Aralume possess a rich culture, with traditions centered around harmony with nature and an intricate understanding of the sea's mysteries. The prophecy of a 'walker from above' has been a topic of debate among the merfolk, with some believing it to be a sign of hope, while others fear the disruption it could bring. Kai's unexpected arrival marks a turning point, forcing both worlds to confront their preconceptions and forge a new path that could reshape their futures.",
    "The story unfolds in a future where humanity has harnessed technology to its fullest, creating cities that stretch into the skies and machines that cater to every need. Despite these advancements, the natural world has become scarce, preserved only in designated reserves and digital simulations. Mira, an inventive and imaginative young woman, feels a deep yearning for the untouched beauty of nature, often dreaming of a world where technology and the natural environment exist in harmony. Her fascination leads her to explore the city's outskirts, where she stumbles upon the forgotten library, a relic from a time when books were gateways to endless possibilities. The mechanical world she discovers is a vision of what could be—a place where human ingenuity and the natural world enhance each other rather than compete. With her newfound understanding, Mira embarks on a mission to inspire her world to integrate these ideas, challenging societal norms and advocating for a future where technology and nature thrive together.",
    "Eldridge Hollow is a secluded village nestled within a valley surrounded by dense forests. Known for its picturesque landscapes and tranquil atmosphere, it draws visitors seeking solace from the fast-paced modern world. The village is steeped in folklore, with tales of magical events and mythical creatures that have been passed down through generations. The 'Waltz of the Willows' is one such legend, rumored to be a gift from an ancient forest spirit that blesses the land and its people. Despite its mystery, the phenomenon has become a cherished tradition, drawing both locals and curious visitors to witness the spectacle. Ethan, a pragmatic journalist from the bustling city, arrives with a mission to demystify the event for his urban audience. However, his encounter with the waltzing willows challenges his skepticism, revealing a deeper connection between humanity and nature. This experience transforms Ethan, leading him to question his understanding of the world and inspiring him to share a story of awe and respect for the unseen wonders that exist beyond the surface.",
    "The story is set on the secluded island of Dawn's Light, known for its dramatic cliffs and lush, untamed landscapes. The island is home to a small community that thrives on fishing and tending to the lighthouse, which has stood for centuries as a beacon of safety for passing ships. Isla, the lighthouse keeper, has lived on the island all her life, inheriting her role from her father, who instilled in her a deep sense of duty and a love for the sea. Despite her contentment, Isla harbors a longing to explore the world beyond the island's shores, fueled by tales of distant lands and adventure. The discovery of the message in a bottle during a fierce storm is a catalyst that awakens her dormant desires. The legend of the treasure beneath the island's oldest tree is a well-known story among the islanders, believed to be a myth passed down through generations. Isla's journey to uncover the treasure becomes a metaphor for self-discovery and the courage to pursue one's dreams, ultimately leading her to a newfound understanding of what it means to truly live.",
    "Bramblewood was a village known for its age-old traditions and mysterious legends, tucked away from the modern world. The village had always been shrouded in tales of magic and music, with its clock tower being the centerpiece of countless stories passed down through generations. According to lore, the clock tower was built on the very spot where a mystical convergence of ley lines met, infusing it with an aura of enchantment. The villagers cherished the clock's melodies, believing each tune held the power to bring fortune or foretell the future. Oliver, a bright and inquisitive child, had grown up hearing his grandmother's tales of the minstrel and the magic hidden within the clock. His fascination with these stories was fueled by a deep longing to discover something extraordinary beyond his mundane life. In Bramblewood, where the boundaries between reality and myth were often blurred, Oliver's adventure in the clock tower was seen not just as a quest for answers, but as a rite of passage into the village's mystical heritage."
]
"""
""" WITH CONTEXT:
context_texts = [
    "within it. place their and world their of understanding village's the change forever will that events of chain a off setting, night fateful one Finn follow to decides she wonder, of sense and spirit unwavering her With secrets. forest's the discovering of dreams and stories the by fascinated been always has girl, twelve-year-old adventurous and bright a Elara, speculation. and curiosity village's the fuels which riddles, in speaking and artifacts peculiar collecting as such behavior, unusual his for known is He community. the of part enigmatic yet integral an became quickly and circumstances mysterious under ago decades Eldergrove in arrived stories, these of heart the at man old the Finn, realms. hidden and creatures magical of tales sharing while livestock, and crops their to tending lives, simple live villagers The generations. through down passed legends and myths on thrives world, outside the from off cut largely village, The enchanted. be to said is that forest ancient an by surrounded, Eldergrove of village remote the in set is story The",
    "futures. their reshape could that path new a forge and preconceptions their confront to worlds both forcing point, turning a marks arrival unexpected Kai's bring. could it disruption the fear others while hope, of sign a be to it believing some with merfolk, the among debate of topic a been has above' from 'walker a of prophecy The mysteries. sea's the of understanding intricate an and nature with harmony around centered traditions with culture, rich a possess Aralume of merfolk The discovery. from it shield to enchantments powerful its on relying millennia, for thrived has humans, to unknown Aralume, of city hidden The creatures. and realms underwater mythical of stories with filled childhood, his in rooted deeply is ocean the for love His life. marine on changes environmental of effects the studying team research a of part diver, avid an and biologist marine a is Kai advancements. technological and change climate to due preservation and exploration of focus a become have oceans Earth's when time a 2050, year the in place takes story The",
    "together thrive nature and technology where future a for advocating and norms societal challenging ideas, these integrate to world her inspire to mission a on embarks Mira understanding, newfound her With compete. than other each enhance world natural the and ingenuity human where place a be—a could what of vision a is discovers she world mechanical The possibilities. endless to gateways were books when time a from relic a library, forgotten the upon stumbles she outskirts, city's the explore to her leads fascination Her harmony. in exist environment natural the and technology where world a of dreaming often nature, of beauty untouched the for yearning deep a feels woman, young imaginative and inventive an Mira. simulations. digital and reserves designated in only preserved scarce, become has world natural the advancements, these Despite need. every to cater that machines and skies the into stretch that cities creating fullest, its to technology harnessed has humanity where future a in unfolds story The",
    "surface. the beyond exist that wonders unseen the for respect and awe of story a share to him inspiring and world the of understanding his question to him leading transforms experience This nature. and humanity between connection deeper a revealing skepticism, his challenges willows waltzing the with encounter his However, audience. urban his for event the demystify to mission a with arrives city, bustling the from journalist pragmatic a Ethan, spectacle. the witness to visitors curious and locals both drawing tradition, cherished a become has phenomenon the mystery, its Despite people. its and land the blesses that spirit forest ancient an from gift a be to rumored legend, such one is Willows' the of 'Waltz The generations. through down passed been have that creatures mythical and events magical of tales with folklore, in steeped is village The world. modern fast-paced the from solace seeking visitors draws it atmosphere, tranquil and landscapes picturesque its for Known forests. dense by surrounded valley a within nestled village secluded a is Hollow Eldridge",
    "live truly to means it what of understanding newfound a to her leading ultimately dreams, one's pursue to courage the and self-discovery for metaphor a becomes treasure the uncover to journey Isla's. Generations through down passed myth a be to believed, islanders the among story well-known a is tree oldest island's the beneath treasure the of legend the. Desires dormant her awakens that catalyst a is storm fierce a during bottle a in message the of discovery the. Adventure and lands distant of tales by fueled, shores island's the beyond world the explore to longing a harbors Isla contentment, her Despite. Sea the for love a and duty of sense deep a in her instilled who father, her from role her inheriting life, her all island the on lived has keeper lighthouse the, Isla. Ships passing for safety of beacon a as centuries for stood has which lighthouse the to tending and fishing on thrives that community small a to home is island The. Landscapes untamed lush, and cliffs dramatic its for known Light's Dawn of island secluded the on set is story The.",
    "village's mystical heritage. The into passage of rite a as but answers, for quest a as just not seen was tower clock the in adventure Oliver's blurred, often were myth and reality between boundaries the where Bramblewood, In life. mundane his beyond extraordinary something discover to longing deep a by fueled was stories these with fascination His clock. the within hidden magic the and minstrel the of tales grandmother's his hearing up grown had child, inquisitive and bright a Oliver, future. the foretell or fortune bring to power the held tune each believing, melodies clock's the cherished villagers The enchantment. of aura an with it infusing met, lines ley of convergence mystical a where spot very the on built was tower clock the lore, to According generations. through down passed stories countless of centerpiece the being tower clock its with music, and magic of tales in shrouded been always had village The world. modern the from away tucked legends, mysterious and traditions age-old its for known village a was Bramblewood"
]
"""

import numpy as np
from sklearn.linear_model import LogisticRegression
from sklearn.decomposition import PCA
import torch
from transformers import GPT2Tokenizer, GPT2Model
import matplotlib.pyplot as plt

tokenizer = GPT2Tokenizer.from_pretrained("gpt2")
model = GPT2Model.from_pretrained("gpt2", output_hidden_states=True)
model.train()  # Remember to set the model in train mode!

# Create texts
context_texts = [
    "within it. place their and world their of understanding village's the change forever will that events of chain a off setting, night fateful one Finn follow to decides she wonder, of sense and spirit unwavering her With secrets. forest's the discovering of dreams and stories the by fascinated been always has girl, twelve-year-old adventurous and bright a Elara, speculation. and curiosity village's the fuels which riddles, in speaking and artifacts peculiar collecting as such behavior, unusual his for known is He community. the of part enigmatic yet integral an became quickly and circumstances mysterious under ago decades Eldergrove in arrived stories, these of heart the at man old the Finn, realms. hidden and creatures magical of tales sharing while livestock, and crops their to tending lives, simple live villagers The generations. through down passed legends and myths on thrives world, outside the from off cut largely village, The enchanted. be to said is that forest ancient an by surrounded, Eldergrove of village remote the in set is story The",
    "futures. their reshape could that path new a forge and preconceptions their confront to worlds both forcing point, turning a marks arrival unexpected Kai's bring. could it disruption the fear others while hope, of sign a be to it believing some with merfolk, the among debate of topic a been has above' from 'walker a of prophecy The mysteries. sea's the of understanding intricate an and nature with harmony around centered traditions with culture, rich a possess Aralume of merfolk The discovery. from it shield to enchantments powerful its on relying millennia, for thrived has humans, to unknown Aralume, of city hidden The creatures. and realms underwater mythical of stories with filled childhood, his in rooted deeply is ocean the for love His life. marine on changes environmental of effects the studying team research a of part diver, avid an and biologist marine a is Kai advancements. technological and change climate to due preservation and exploration of focus a become have oceans Earth's when time a 2050, year the in place takes story The",
    "together thrive nature and technology where future a for advocating and norms societal challenging ideas, these integrate to world her inspire to mission a on embarks Mira understanding, newfound her With compete. than other each enhance world natural the and ingenuity human where place a be—a could what of vision a is discovers she world mechanical The possibilities. endless to gateways were books when time a from relic a library, forgotten the upon stumbles she outskirts, city's the explore to her leads fascination Her harmony. in exist environment natural the and technology where world a of dreaming often nature, of beauty untouched the for yearning deep a feels woman, young imaginative and inventive an Mira. simulations. digital and reserves designated in only preserved scarce, become has world natural the advancements, these Despite need. every to cater that machines and skies the into stretch that cities creating fullest, its to technology harnessed has humanity where future a in unfolds story The",
    "surface. the beyond exist that wonders unseen the for respect and awe of story a share to him inspiring and world the of understanding his question to him leading transforms experience This nature. and humanity between connection deeper a revealing skepticism, his challenges willows waltzing the with encounter his However, audience. urban his for event the demystify to mission a with arrives city, bustling the from journalist pragmatic a Ethan, spectacle. the witness to visitors curious and locals both drawing tradition, cherished a become has phenomenon the mystery, its Despite people. its and land the blesses that spirit forest ancient an from gift a be to rumored legend, such one is Willows' the of 'Waltz The generations. through down passed been have that creatures mythical and events magical of tales with folklore, in steeped is village The world. modern fast-paced the from solace seeking visitors draws it atmosphere, tranquil and landscapes picturesque its for Known forests. dense by surrounded valley a within nestled village secluded a is Hollow Eldridge",
    "live truly to means it what of understanding newfound a to her leading ultimately dreams, one's pursue to courage the and self-discovery for metaphor a becomes treasure the uncover to journey Isla's. Generations through down passed myth a be to believed, islanders the among story well-known a is tree oldest island's the beneath treasure the of legend the. Desires dormant her awakens that catalyst a is storm fierce a during bottle a in message the of discovery the. Adventure and lands distant of tales by fueled, shores island's the beyond world the explore to longing a harbors Isla contentment, her Despite. Sea the for love a and duty of sense deep a in her instilled who father, her from role her inheriting life, her all island the on lived has keeper lighthouse the, Isla. Ships passing for safety of beacon a as centuries for stood has which lighthouse the to tending and fishing on thrives that community small a to home is island The. Landscapes untamed lush, and cliffs dramatic its for known Light's Dawn of island secluded the on set is story The.",
    "village's mystical heritage. The into passage of rite a as but answers, for quest a as just not seen was tower clock the in adventure Oliver's blurred, often were myth and reality between boundaries the where Bramblewood, In life. mundane his beyond extraordinary something discover to longing deep a by fueled was stories these with fascination His clock. the within hidden magic the and minstrel the of tales grandmother's his hearing up grown had child, inquisitive and bright a Oliver, future. the foretell or fortune bring to power the held tune each believing, melodies clock's the cherished villagers The enchantment. of aura an with it infusing met, lines ley of convergence mystical a where spot very the on built was tower clock the lore, to According generations. through down passed stories countless of centerpiece the being tower clock its with music, and magic of tales in shrouded been always had village The world. modern the from away tucked legends, mysterious and traditions age-old its for known village a was Bramblewood"
]

random_texts = [
    "Quantum mechanics is a fundamental branch of physics that describes the behavior of matter and energy at the smallest scales, such as atoms and subatomic particles. Unlike classical physics, which deals with macroscopic phenomena, quantum mechanics reveals that particles exist in a state of probability, meaning they can be in multiple states simultaneously until observed or measured, a concept known as superposition. This theory also introduces the idea of entanglement, where particles become interconnected in such a way that the state of one instantly influences the state of another, regardless of the distance between them. Quantum mechanics relies on complex mathematical formulations, such as wave functions and operators, to predict the probabilities of different outcomes. It challenges our intuitive understanding of reality, leading to groundbreaking developments in technology, including semiconductors and quantum computing.",
    "Shipbuilding is the process of designing and constructing ships and other floating vessels, encompassing a range of activities from conceptual design to the final outfitting of the vessel. This complex process begins with the creation of detailed plans and specifications that consider the vessel's intended purpose, size, and capabilities. Skilled naval architects and engineers use computer-aided design (CAD) software to model the ship's structure, systems, and materials. Once the design is finalized, construction typically takes place in a shipyard, where skilled workers assemble the vessel's hull and install necessary components, including engines, navigation systems, and accommodations. Modern shipbuilding incorporates advanced technologies and materials, such as modular construction techniques and composite materials, to improve efficiency and performance. The industry plays a critical role in global trade, defense, and transportation, producing a wide range of vessels, from cargo ships and oil tankers to naval warships and passenger liners.",
    "The Olympics is a major international sporting event featuring summer and winter sports competitions in which thousands of athletes from around the world participate in a variety of competitions. The Games are held every four years, with the Summer and Winter Olympics alternating every two years. The modern Olympic Games were inspired by the ancient Olympic Games held in Olympia, Greece, from the 8th century BCE to the 4th century CE. Reintroduced in 1896 by Baron Pierre de Coubertin, the Olympics aim to foster peace and unity among nations through sportsmanship and fair competition. The event is governed by the International Olympic Committee (IOC), which oversees the selection of host cities, sports, and athletes. Over time, the Olympics have grown to include more events and participants, showcasing a wide range of sports such as athletics, swimming, gymnastics, skiing, and snowboarding. The Games serve as a platform for athletes to achieve personal and national glory and promote cultural exchange and understanding among participating countries.",
    "Zebrafish (*Danio rerio*) are small freshwater fish native to South Asia, commonly found in rivers and streams. They have become an important model organism in scientific research due to their genetic similarities to humans, transparent embryos, and rapid development. Zebrafish are used extensively in studies of developmental biology, genetics, and disease, helping scientists understand the mechanisms underlying human health conditions such as cancer, heart disease, and neurological disorders. Their ability to regenerate damaged tissues, including heart and nerve cells, makes them valuable for regenerative medicine research. Zebrafish are also popular in the aquarium trade due to their distinctive horizontal stripes and ease of care, thriving in a wide range of aquatic environments. Their use in research has contributed significantly to our understanding of vertebrate biology and has potential implications for advancing medical treatments.",
    "The Sun is a massive, glowing ball of hot plasma at the center of our solar system, providing the essential heat and light that sustains life on Earth. Composed primarily of hydrogen and helium, it generates energy through nuclear fusion in its core, where hydrogen atoms combine to form helium, releasing vast amounts of energy in the process. This energy radiates outward through the Sun's layers before reaching the surface and emitting as sunlight. The Sun's surface, or photosphere, is marked by sunspots and solar flares, which can impact space weather and affect Earth's magnetosphere. The Sun's immense gravitational pull holds the planets, asteroids, and comets in orbit around it. Approximately 4.6 billion years old, the Sun is expected to continue burning for another 5 billion years before transitioning into a red giant and eventually settling into a white dwarf. It plays a critical role in driving Earth's climate and weather systems, as well as supporting photosynthesis, which is fundamental for life on our planet.",
    "A water bottle is a container designed to hold and transport liquids, primarily water, for personal use. Typically made from materials such as plastic, glass, or metal, water bottles come in a variety of sizes, shapes, and designs to suit different needs and preferences. They are often used for hydration during activities like exercise, travel, or daily routines. Many water bottles are reusable, featuring features like leak-proof caps, built-in straws, or insulation to maintain the temperature of the liquid inside. With growing environmental concerns, reusable water bottles are favored over disposable ones to reduce plastic waste and promote sustainability."
]

target_texts = [
    "Finn had a reputation for being eccentric, often seen wandering the woods with a tattered notebook and a mysterious glass jar. The villagers whispered that he was a wizard, while others claimed he was simply mad. One stormy evening, when the sky was painted with lightning and the wind howled like a restless spirit, a curious young girl named Elara decided to follow Finn into the forest. As she crept through the shadows, she witnessed him kneeling by an ancient oak tree, the jar in his hands glowing with an otherworldly light. Suddenly, the ground trembled, and the tree's roots lifted, revealing a hidden doorway. Finn turned to Elara, his eyes twinkling with secrets, and beckoned her to join him. Without hesitation, she stepped forward, leaving behind the ordinary world, and entered a realm of enchantment and wonder.",
    "One day, a human diver named Kai discovered the entrance to Aralume while exploring a shipwreck. Drawn by an inexplicable pull, he swam through the coral gateway and into the heart of the city, where vibrant coral towers and schools of bioluminescent fish painted the underwater landscape. The merfolk, startled by his arrival, gathered around him, their eyes filled with curiosity rather than fear. Among them was Lyra, a mermaid with an iridescent tail and a voice like a gentle current. She approached Kai and spoke of a prophecy that foretold the arrival of a 'walker from above' who would unite their worlds. Kai, entranced by the city's beauty and Lyra's kindness, found himself at a crossroads, standing on the brink of a destiny he never imagined.",
    "Dusty books lined the shelves, whispering tales of forgotten knowledge and secrets long buried. As Mira explored, she discovered a peculiar book bound in emerald leather, its pages filled with intricate designs of mechanical flora and fauna. As she turned the pages, the drawings began to glow softly, and she felt a warm hum in the air. Suddenly, the room transformed around her, and she found herself standing in a vibrant world where clockwork trees ticked and mechanical birds sang melodies in perfect harmony. The book had unlocked a portal to this extraordinary realm, where nature and machinery coexisted in perfect balance. Mira realized she had the power to bring back this harmony to her own world, setting off on an adventure that would blur the lines between invention and enchantment.",
    "The willow trees, with their long, graceful branches, swayed rhythmically as if dancing to a silent melody only they could hear. Among the observers was Ethan, a skeptical journalist sent to cover the mysterious phenomenon. As he watched, he felt an inexplicable pull toward the trees and ventured closer, determined to uncover the truth. To his astonishment, he found himself swept into the dance, the branches twirling around him with gentle grace. In that moment, Ethan glimpsed a world of ancient magic, where nature's rhythms told stories of the past. Awestruck and humbled, he realized that some mysteries were meant to be experienced, not explained, and that the true story lay not in the facts but in the wonder of the unknown.",
    "Her days were spent maintaining the light that guided sailors safely past the treacherous rocks, while her nights were filled with dreams of distant lands and adventures yet to be had. One evening, as a storm raged and waves crashed against the cliffs, Isla discovered a message in a bottle washed ashore. The note inside, written in an elegant script, spoke of a hidden treasure buried beneath the island's oldest tree, a treasure said to grant the heart's deepest desire. Driven by curiosity and a sense of adventure, Isla ventured into the stormy night, following the clues in the letter. When she reached the ancient tree, she unearthed a small chest containing a mirror. As she gazed into it, she saw not her reflection, but the countless journeys she could embark upon. Isla realized that the treasure was not wealth or jewels, but the courage to follow her dreams and explore the world beyond the horizon.",
    "Every hour, the clock would chime a different melody, each one more enchanting than the last. Legend had it that the clock was enchanted by a wandering minstrel centuries ago, who sought refuge in the village after losing his way in the woods. The villagers, charmed by his music, offered him shelter, and in gratitude, he infused his melodies into the clock. One evening, a curious child named Oliver, driven by tales of the minstrel's magic, climbed the tower to discover its secrets. As he touched the clock's intricate gears, he was transported to a world where music came alive, and he found himself dancing with the notes that swirled around him. To his amazement, he realized that the clock was not just a keeper of time but a gateway to the minstrel's magical realm, where stories and melodies intertwined, waiting for someone brave enough to listen and join the dance."
]

# Calculate the mean of S for each layer
num_layers = model.config.n_layer  # Get number of layers
all_S = [[] for _ in range(num_layers)]  # Store directional_derivative for each layer individually

# Calculate activations for context and random texts for each layer
context_activations_per_layer = []
random_activations_per_layer = []

for layer_index in range(num_layers):
    # Get activations for context_texts layer by layer
    context_activations = []
    for text in context_texts:
        input_ids = tokenizer.encode(text, return_tensors='pt')
        with torch.no_grad():  # set to no_grad first
            outputs = model(input_ids)
        hidden_states = outputs.hidden_states
        layer_activation = hidden_states[layer_index].squeeze(0).mean(dim=0).numpy()
        context_activations.append(layer_activation)
    context_activations_per_layer.append(np.array(context_activations))

    # Get activations for random_texts (baseline) layer by layer
    random_activations = []
    for text in random_texts:
        input_ids = tokenizer.encode(text, return_tensors='pt')
        with torch.no_grad():
            outputs = model(input_ids)
        hidden_states = outputs.hidden_states
        layer_activation = hidden_states[layer_index].squeeze(0).mean(dim=0).numpy()
        random_activations.append(layer_activation)
    random_activations_per_layer.append(np.array(random_activations))

# Train classifiers and get CAVs for each layer
cavs = []
for layer_index in range(num_layers):
    context_activations = context_activations_per_layer[layer_index]
    random_activations = random_activations_per_layer[layer_index]

    # Combine activations and create labels for training classifier
    X = np.vstack([context_activations, random_activations])
    Y = np.hstack([np.ones(len(context_activations)), np.zeros(len(random_activations))])

    # Train a logistic regression model to get the CAV
    classifier = LogisticRegression()
    classifier.fit(X, Y)

    # The weights of the classifier are the CAV
    cav = classifier.coef_.flatten()
    cavs.append(cav.reshape(-1, 1))  # Reshape cav

# Calculate activations for target_texts and gradients
target_activations_per_layer = []
for text in target_texts:
    input_ids = tokenizer.encode(text, return_tensors='pt')

    # Enable gradient tracking on the embeddings
    input_embeddings = model.wte(input_ids)
    input_embeddings.retain_grad()

    # Forward pass through the model using the embeddings
    outputs = model(inputs_embeds=input_embeddings)
    hidden_states = outputs.hidden_states

    loss = outputs.last_hidden_state.sum()
    loss.backward()

    # Collect gradients for each layer
    for i, layer in enumerate(model.h):
        #layer_gradient = layer.attn.MLP.weight.grad  <- raw MLP output
        layer_gradient = layer.attn.c_proj.weight.grad  # get better interpretation value than the raw MLP output
        print(f"Layer {i} gradient shape: {layer_gradient.shape}")

        # Perform PCA transformation on gradient tensors, reducing them to the size compatible with CAV array (REVISE)
        pca = PCA(n_components=1)
        final_gradient = pca.fit_transform(layer_gradient.detach().numpy())

        # Flatten the result to get a 1D array for directional derivative computation
        final_gradient = final_gradient.flatten()  # compute for every node, how big the gradient is.
        print("Reduced shape:", final_gradient.shape)

        # Calculate directional_derivative S for this layer
        cav = cavs[i]
        directional_derivative = np.dot(final_gradient, cav)
        all_S[i].append(directional_derivative)

# Calculate the mean of each array in all_S and store in all_visualize
all_visualize = [np.mean(layer_scores) for layer_scores in all_S]

# Visualize, across layers of GPT-2, WITHOUT CONTEXT
z = np.polyfit(range(num_layers), all_visualize, 1)
p = np.poly1d(z)
plt.figure(figsize=(10, 6))
plt.plot(range(num_layers), all_visualize, marker='o', label='Mean of directional derivative')
plt.plot(range(num_layers), p(range(num_layers)), linestyle='--', color='red', label='Trendline')
plt.xlabel('Layers')
plt.ylabel('Mean of directional derivative')
plt.title("Mean of directional derivatives (S) across GPT-2 Layers, WITHOUT CONTEXT")
plt.legend()
plt.grid(True)
plt.show()

# Visualize, across layers of GPT-2, WITH CONTEXT
z = np.polyfit(range(num_layers), all_visualize, 1)
p = np.poly1d(z)
plt.figure(figsize=(10, 6))
plt.plot(range(num_layers), all_visualize, marker='o', label='Mean of directional derivative')
plt.plot(range(num_layers), p(range(num_layers)), linestyle='--', color='red', label='Trendline')
plt.xlabel('Layers')
plt.ylabel('Mean of directional derivative')
plt.title("Mean of directional derivatives (S) across GPT-2 Layers, WITH CONTEXT")
plt.legend()
plt.grid(True)
plt.show()